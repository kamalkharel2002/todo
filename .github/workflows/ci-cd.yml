name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  API_BASE_URL: http://localhost:5001/api
  REGISTRY: docker.io
  IMAGE_BACKEND: ${{ secrets.DOCKER_USERNAME }}/todo-backend
  IMAGE_FRONTEND: ${{ secrets.DOCKER_USERNAME }}/todo-frontend

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend (dev)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Backend/Dockerfile.dev
          push: false
          load: true
          tags: todo-backend:ci

      - name: Build frontend (dev)
        uses: docker/build-push-action@v6
        with:
          context: Frontend/todo-frontend        # ✅ same fix here
          file: Frontend/todo-frontend/Dockerfile.dev
          push: false
          load: true
          tags: todo-frontend:ci

      - name: Start services
        run: docker compose up -d --build

      - name: Wait for MySQL
        run: |
          for i in {1..60}; do
            READY=$(docker inspect -f '{{json .State.Health.Status}}' todo-mysql || echo '"starting"')
            [ "$READY" = '"healthy"' ] && exit 0
            sleep 2
          done
          echo 'MySQL not healthy' && exit 1

      - name: Wait for Redis
        run: |
          for i in {1..60}; do
            READY=$(docker inspect -f '{{json .State.Health.Status}}' todo-redis || echo '"starting"')
            [ "$READY" = '"healthy"' ] && exit 0
            sleep 2
          done
          echo 'Redis not healthy' && exit 1

      - name: Wait for backend health
        run: |
          for i in {1..60}; do
            curl -sf http://localhost:5001/api/health && exit 0
            sleep 2
          done
          echo 'Backend not healthy' && exit 1

      - name: Set up Node.js for tests
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install test dependencies
        working-directory: tests
        run: npm ci || npm install

      - name: Run tests (Jest)
        working-directory: tests
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}
        run: npm test -- --runInBand

      - name: Show backend logs on failure
        if: failure()
        run: docker logs todo-backend || true

      - name: Teardown services
        if: always()
        run: docker compose down -v

      - name: CI Summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          echo "## 🎯 CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$STATUS" = "success" ]; then
            echo "### ✅ Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Build Details:**" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Backend build completed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Frontend build completed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ MySQL health check passed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Redis health check passed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Backend health check passed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ All tests executed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Pipeline encountered errors. Check logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  cd:
    needs: ci
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Backend/Dockerfile.dev
          push: true
          tags: |
            ${{ env.IMAGE_BACKEND }}:latest
            ${{ env.IMAGE_BACKEND }}:${{ github.sha }}

      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          context: Frontend/todo-frontend        # ✅ same fix here
          file: Frontend/todo-frontend/Dockerfile.dev
          push: true
          tags: |
            ${{ env.IMAGE_FRONTEND }}:latest
            ${{ env.IMAGE_FRONTEND }}:${{ github.sha }}

      - name: CD Summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          echo "## 🚀 CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$STATUS" = "success" ]; then
            echo "### ✅ Status: DEPLOYMENT SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Docker images successfully built and pushed to registry!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Published Images:**" >> $GITHUB_STEP_SUMMARY
            echo "- 🐳 \`${{ env.IMAGE_BACKEND }}:latest\`" >> $GITHUB_STEP_SUMMARY
            echo "- 🐳 \`${{ env.IMAGE_BACKEND }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- 🐳 \`${{ env.IMAGE_FRONTEND }}:latest\`" >> $GITHUB_STEP_SUMMARY
            echo "- 🐳 \`${{ env.IMAGE_FRONTEND }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Status: DEPLOYMENT FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Failed to build or push Docker images. Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY